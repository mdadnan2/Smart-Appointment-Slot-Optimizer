generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum ShiftType {
  MORNING
  EVENING
  FULL_DAY
}

model User {
  id                   String    @id @default(uuid())
  email                String    @unique
  password             String
  name                 String
  role                 Role      @default(USER)
  phone                String
  resetToken           String?   @unique
  resetTokenExpiry     DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  appointments Appointment[]
  provider     Provider?

  // ✅ OPTIMIZATION: Index for faster email lookups during login
  @@index([email])
  @@map("users")
}

model Provider {
  id                     String   @id @default(uuid())
  userId                 String   @unique
  specialty              String
  timezone               String   @default("UTC")
  defaultServiceDuration Int      @default(30)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  workingHours WorkingHour[]
  breaks       Break[]
  services     Service[]
  appointments Appointment[]
  holidays     Holiday[]

  // ✅ OPTIMIZATION: Index for faster provider lookups
  @@index([userId])
  @@map("providers")
}

model WorkingHour {
  id         String    @id @default(uuid())
  providerId String
  dayOfWeek  DayOfWeek
  shiftType  ShiftType @default(FULL_DAY)
  startTime  String
  endTime    String
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // ✅ OPTIMIZATION: Composite index for slot engine queries
  @@index([providerId, dayOfWeek, isActive])
  @@map("working_hours")
}

model Break {
  id          String   @id @default(uuid())
  providerId  String
  title       String
  startTime   DateTime
  endTime     DateTime
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // ✅ OPTIMIZATION: Composite index for slot engine date range queries
  @@index([providerId, startTime, endTime])
  @@map("breaks")
}

model Holiday {
  id          String   @id @default(uuid())
  providerId  String
  title       String
  date        DateTime @db.Date
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // ✅ OPTIMIZATION: Composite index for holiday lookups
  @@index([providerId, date])
  @@map("holidays")
}

model Service {
  id          String   @id @default(uuid())
  providerId  String
  name        String
  duration    Int
  price       Float?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  provider     Provider      @relation(fields: [providerId], references: [id], onDelete: Cascade)
  appointments Appointment[]

  // ✅ OPTIMIZATION: Composite index for active service queries
  @@index([providerId, isActive])
  @@map("services")
}

model Appointment {
  id         String            @id @default(uuid())
  providerId String
  userId     String
  serviceId  String
  startTime  DateTime
  endTime    DateTime
  status     AppointmentStatus @default(PENDING)
  notes      String?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  service  Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // ✅ OPTIMIZATION: Critical indexes for performance
  // Index 1: Slot conflict detection (most critical)
  @@index([providerId, startTime, endTime, status])
  
  // Index 2: User appointment queries
  @@index([userId, startTime])
  
  // Index 3: Analytics queries (monthly stats)
  @@index([providerId, status, startTime])
  
  @@map("appointments")
}
